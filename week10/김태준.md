### 21장 로깅과 사용 추적

#### 21.1 로그란 무엇인가 ?
 - 로깅을 하는 이유
   - 서버나 프락시의 문제를 찾는다. ( 에러로그 )
   - 웹 사이트 접근 통계를 낸다. ( 통계로그 )
 - 보통은 트랜잭션의 기본적인 항목들만 로깅한다.
   - HTTP 메서드
   - 클라이언트와 서버의 HTTP 버전
   - 요청받은 리소스의 URL
   - 응답의 HTTP 상태 코드
   - 요청과 응답 메시지의 크기 (모든 엔티티 본문을 포함)
   - 트랜잭션이 일어난 시간 ( 보통은 시간으로 먼저 grep해서 찾음 )
   - Referer와 User-Agent의 헤더값 ( 어디서 부터 왔는지, 브라우저 정보 확인)

#### 21.2 로그 포맷
  - 상용 혹은 오픈소스 HTTP 에플리케이션은 대부분, 표준 로그 포맷을 한 개 이상 지원한다. -> 로그에서 통계를 추출할때 로그를 write하는 포맷이 있다면 원하는 정보를 추출하기도 편할 것이다.

##### 21.2.1 일반 로그 포맷
 - 많은 서버가 이 로그 포맷을 기본으로 사용한다. ( 한 로그에 요청과 응답에 대한 데이터를 같이 남긴다 ? -> 보통 따로 남기지 않나 ?, file or db )

|필드|설명|
|------|---|
|remotehost|요청한 컴퓨터의 호스트 명 혹은 IP 주소|
|username|ident 검색을 수행했다면, 인증된 요청자의 사용자 이름이 있다.|
|auth-username|인증을 수행했다면, 인증된 요청자의 사용자 이름이 있다.|
|timestamp|요청 날짜와 시간|
|request-line|HTTP 요청의 행을 그대로 기술한다. ex. "GET /index.html HTTP/1.1"|
|response-code|응답으로 보내는 HTTP 상태 코드|
|response-size|응답 엔터티의 Content-Length|

##### 21.2.2 혼합 로그 포맷
 - 아파치 같은 서버들이 지원한다.
 - 혼합 로그 포맷은 일반 로그 포맷과 매우 유사하다. (추가된 필드 2개를 제외하면 똑같다.)
 - 일반 로그 포맷에 Referer 필드와 User-Agent값이 추가됬다.
   - Referer 필드는 해당 URL이 어디서 왔는지에 대한 정보를 제공한다. 
   - User-Agent 필드는 클라이언트의 정보( os, 브라우저 정보..등등)를 확인하는데 유용하다.

##### 21.2.3 넷스케이프 확장 로그 포맷
 - 넷스케이프가 상용 HTTP 에플리케이션이 되면서 만들어진 로그 포맷
 - 넷스케이프 확장 로그 포멧은 다음과 같다.
  
  |필드|설명|
|------|---|
|proxy-response-code|트랜잭션이 프락시를 거칠 경우, 서버에서 프락시로의 HTTP 응답 코드|
|proxy-response-size|트랜잭션이 프락시를 거칠 경우, 서버가 프락시에 전달하는 응답 엔터티의 Content-Length|
|client-request-size| 클라이언트가 프락시로 보내는 요청의 본문이나 엔터티의 Content-Length|
|proxy-request-size|트랜잭션이 프락시를 거칠 경우, 프락시가 서버로 보내는 요청의 본문이나 엔터티의 Content-Length|
|client-request-hdr-size|클라이언트 요청 헤더의 바이트 길이|
|proxy-response-hdr-size|트랜잭션이 프락시를 거칠 경우, 프락시가 요청자에게 보내는 응답 헤더의 바이트 길이|
|proxy-request-hdr-size|트랜잭션이 프락시를 거칠 경우, 프락시가 서버로 전송하는 요청 헤더의 바이트 길이|
|server-response-hdr-size|서버 응답 헤더의 바이트 길이|
|proxy-timestamp|트랜잭션이 프락시를 걸칠 경우, 요청과 응답이 프락시를 통해 오가는 총 시간 (초 단위)

##### 21.2.4 넷스케이프 확장 2 로그 포맷
 - 넷스케이프 확장 2 포맷은 확장 로그 포맷에서 HTTP 프락시와 웹 캐시 애플리케이션과 관련한 더 많은 정보를 포함한다.
 - 기존 넷스케이프 확장해더에서 추가된 필드들은 다음과 같다.
  
|필드|설명|
|------|---|
|route|프락시가 클라이언트에 요청을 만드는 데 사용하는 경로|
|client-finish-status-code|클라이언트의 종료 상태 코드로, 클라이언트가 프락시로 보낸 요청이 성공적으로 완료되었는지 혹은, 인터럽트에 걸렸는지 기술한다.|
|proxy-finish-status-code|프락시의 종료 상태 코드로, 프락시가 서버로 보낸 요청이 성공적으로 완료되었는지 혹은 인터럽트에 걸렸는지 기술한다.
|cache-result-code|캐시 결과 코드로, 캐시가 요청에 어떻게 응답했는지 기술한다.|

##### 21.2.5 스쿼드(Squid) 프락시 로그 포맷
 - 스쿼드 프락시 캐시는 웹 분야에서 권이 있는 프로젝트다. ?
 - 위 프로젝트에 활용하기 위해 자체 로그 포맷으로 스쿼드 포맷을 적용함.
 - 스쿼드 로그 엔트리의 포맷은 다음과 같다.
  
 |필드|설명|
|------|---|
|timestamp|요청이 도착한 시간을 GMT 1970년 1월 1일을 기준으로 지난 시간을 초단위로 기술
|time-elapsed|요청과 응답이 프락시를 통해 오고간 총 시간을 밀리초로 기술|
|host-ip|클라이언트의 IP 주소|
|result-code/status|result 필드에는 이 요청에 프락시가 어떤 일을 했는지 스쿼드 방식으로 기술된다. code필드는 프락시가 클라이언트에 보낸 HTTP 응답 코드이다.|
|size|프락시가 클라이언트에게 보낸 HTTP 응답 헤더와 본문을 포함한 응답의 길이가 바이트 단위로 기술된다.|
|method|클라이언트 요청의 HTTP 메서드|
|url|클라이언트 요청의 URL|
|rfc931-ident| 클라이언트에 인증된 사용자 이름|
|hierachy/form|hierachy 필드에는 프락시가 클라이언트로 요청을 보내면서 거친 경로를 기술한다. form 필드는 프락시가 요청을 만들게 한 서버의 이름을 기술한다.|
|content-type|프락시 응답 엔터티의 Content-Type|

#### 21.3 적중 계량하기
 - 서버와 클라이언트 사이에 캐시가 존재하게 되면 클라이언트의 요청에 서버에 도달하지 않을 수 있기 때문에 ( cache hit ) 로그 파일에 누락이 생길 수 있다.
 - 로그 데이터의 유실을 막기 위해, 콘텐츠 제공자는 중요한 페이지의 캐시를 파기한다. -> 해당 페이지의 모든 요청이 서버로 가서 로그 유실은 없겠지만 요청에 대한 응답 속도가 느려지고, 원 서버에 부하가 가중될 수 있다. -> 캐시 파기를 하지 않고 적중 계량을 통해 해결 할 수 있다.
 - 적중 계량 규약은 HTTP의 확장으로, 캐시가 정기적으로 캐시 접근 통계를 원 서버에 보고하도록 한다.

##### 21.3.1 개요
 - 적중 계량 규약은 캐시와 서버가 접근 정보를 공유하고, 사용할 수 있는 캐시 리소스의 양을 제어할 수 있는 몇가지 기능에 관한 HTTP 확장을 정의한다. -> 완벽한 해결책은 아니지만, 서버가 원하는 통계정보는 받아 볼 수 있다.

##### 21.3.2 Meter 헤더 ( 그림 21-1 참고 )
 - 적중 계량 확장은 Meter라는 새로운 헤더를 추가했다. ( Cache-Control 해더에 다양한 캐시 지시자를 기술하듯, 캐시나 서버는 Meter 해더에 사용량이나 보고에 관한 지시자를 기술 할 수 있다.)
 - 다음 표는 Meter 헤더에 기술할 수 있는 지시자와 그것을 보낼 수 있는 주체가 기술 되어있다. (캐시 or 서버)

 |지시자|약어|주체|설명|
|------|---|---|---|
|will-report-and-limit|w|캐시|캐시는 사용량을 보고하고 서버가 기술한 모든 사용 제한에 복종한다.|
|wont-report|x|캐시|캐시는 사용 제한에 복종하지만, 사용량을 보고하지는 않는다.|
|wont-limit|y|캐시|캐시는 사용량 보고를 하지만 사용 제한은 없다.|
|count|c|캐시|"사용 횟수/재사용 횟수" 순으로 정수로 기술하는 보고 지시자로, ":count=2/4" 같은 식으로 작성된다."|
|max-uses|u|서버|서버가 캐시를 사용해서 응답할 수 있는 최대 횟수를 기술한다. ex. 
"max-uses=100"|
|do-report|d|서버|서버가 프락시에게 사용량 보고를 요구한다.|
|dont-report|e|서버|서버가 사용량 보고를 원하지 않는다.|
|timeout|t|서버|서버가 리소스를 계량할 때 시간 제한을 거는 데 사용한다.|
|wont-ask|n|서버|서버는 계량 정보를 원하지 않는다.|

#### 21.4 개인 정보 보호에 대해
 - 웹 애플리케이션 개발자와 관리자는 사용자의 HTTP 트랜잭션을 추적하고 있다. -> 로깅하는 웹 서버와 프락시는 사용자의 개인 정보를 관리하는데 주의해야한다.
 - 로깅은 관리자와 개발자에게 유용한 도구이지만 로깅을 당하는 사용자들의 인지나 허가가 없으면 로깅이 사생활 침해가 된다는 사실을 유념해야 한다.





